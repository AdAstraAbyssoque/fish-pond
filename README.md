# 锦鲤池塘 - 大世界探索

基于 Regl + WebGL 的可操控大地图锦鲤模拟系统。

## 技术栈

- **Regl**: WebGL 渲染库
- **Canvas 2D**: 鱼体渲染与图像采样
- **摄像机系统**: 视野跟随与变换
- **键盘控制**: WASD 玩家操控
- **视野剔除**: 性能优化

## 核心特性

### 玩家控制
- WASD 控制橙色锦鲤移动
- 无输入时自动 AI 行为
- 摄像机平滑跟随

### 大地图
- 2x2 世界（4倍屏幕大小）
- 20-24 条锦鲤分布
- 鱼群跟随玩家（800px 吸引范围）
- 视野剔除（只渲染可见鱼）
- 优雅的背景参照物：
  - 石头（柔和渐变 + 轮廓线）
  - 水草（贝塞尔曲线摆动）
  - 涟漪圆环
  - Tile 分割线

### Debug 模式
- V 键切换 Debug 视野
- 鼠标滚轮缩放（0.2x - 1.5x）
- 显示地图网格和边界
- 自动降低粒子密度（防爆炸）

### 粒子系统
- 60000 粒子池（支持更多鱼）
- 图像逐像素采样
- 色彩继承（RGBA）
- 尾巴动态拖尾
- Debug 模式自适应降级

## 快速开始

安装依赖:

```bash
npm install
```

启动服务:

```bash
npm run serve
```

访问 `http://localhost:3000` 查看效果。

## 控制方式

- **W/A/S/D**: 控制橙色锦鲤
- **V**: 切换 Debug 视野模式
- **鼠标滚轮**: Debug 模式缩放视野
- **左键**: 切换选中鱼（展示用）

## 架构说明

### 粒子系统 (`simple-particles.js`)

- CPU 管理粒子生命周期
- GPU 渲染（WebGL Points）
- 图像采样（1px 精度）
- 尾巴识别与特效
- Debug 模式自动降级（3px 采样）

### 摄像机 (`camera.js`)

- 跟随算法（smoothness = 0.08）
- 视野剔除（300px margin）
- 坐标转换（世界 ↔ 屏幕）
- 缩放控制（0.2x - 1.5x）

### 键盘控制 (`keyboard.js`)

- WASD 捕获与归一化
- 玩家输入时：控制力 + 避障 + 边界
- 无输入时：完整 Boids + 噪声

### 大地图

- 2x2 tiles（每 tile = 屏幕）
- 20-24 条鱼 / 4 个群组
- 300px 边界 margin
- 玩家鱼吸引力（800px 范围，强度随距离衰减）
- 渲染流程：更新 → 剔除 → 变换 → 渲染

### 地图参照物 (`landmarks.js`)

- 石头：径向渐变 + 细轮廓线（优雅半透明）
- 水草：贝塞尔曲线 + 双层渲染（流畅摆动）
- 涟漪：静态多圈环形装饰
- Tile 边界：虚线分割
- 视野剔除优化（只渲染可见物）

### Debug 模式

- V 键切换（初始 0.35x）
- 滚轮缩放
- 粒子倍率：0.2 - 0.5
- 视觉：红色边界 + 蓝色网格

## 文件结构

```
fish-pond/
├── js/
│   ├── main.js              # 主循环与大地图
│   ├── camera.js            # 摄像机系统
│   ├── keyboard.js          # 键盘控制
│   ├── landmarks.js         # 地图参照物
│   ├── simple-particles.js  # 粒子系统
│   ├── fish.js              # 鱼 AI 与采样
│   ├── chain.js             # 骨骼链
│   ├── noise.js             # Perlin 噪声
│   └── utils.js             # 工具函数
├── css/
│   └── style.css
├── index.html
└── package.json
```

## 性能优化

- 视野剔除（只渲染可见鱼）
- Debug 模式自动降级
- GPU 批量渲染
- 粒子对象池
- 图像采样缓存

## 浏览器要求

需要支持 WebGL 的现代浏览器：
- Chrome 90+
- Firefox 88+
- Safari 14+
