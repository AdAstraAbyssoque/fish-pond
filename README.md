# 锦鲤池塘 - Fish Pond Simulation

一个基于 WebGL 和 Regl GPGPU 的高性能锦鲤池塘模拟系统，支持玩家控制、鱼群 AI、粒子特效和大地图探索。

## 📖 项目概述

这是一个交互式的锦鲤池塘模拟器，玩家可以控制一条橙色锦鲤在大型池塘中游动，其他锦鲤会智能地跟随玩家。项目使用 WebGL 和 Regl 实现了高性能的粒子系统，通过图像采样技术将鱼体渲染为粒子效果，创造出流畅的视觉效果。

### 核心 Idea

- **玩家控制**：WASD 控制橙色锦鲤，体验第一人称视角的池塘探索
- **智能鱼群**：基于 Boids 算法的鱼群 AI，实现分离、对齐、聚集等行为
- **粒子渲染**：使用 Regl + WebGL 将鱼体渲染为粒子效果，支持 60,000+ 粒子
- **大地图系统**：支持大型地图（基于背景图片尺寸），摄像机平滑跟随
- **碰撞检测**：基于图像遮罩的碰撞检测系统，鱼只能在池塘区域游动
- **视觉效果**：涟漪系统、荷叶遮罩、粒子拖尾等丰富的视觉效果

## 🛠️ 技术栈

### 核心框架
- **Regl** (`^2.1.1`) - WebGL 渲染库，用于高性能粒子系统
- **Three.js** (`^0.160.0`) - 3D 库（已引入，部分功能使用）
- **Canvas 2D API** - 鱼体渲染、图像采样、背景绘制

### 核心技术

#### 1. 粒子系统 (`simple-particles.js`)
- **GPGPU 渲染**：使用 Regl 在 GPU 上批量渲染粒子
- **图像采样**：从离屏 Canvas 逐像素采样鱼体颜色
- **生命周期管理**：CPU 端管理粒子生命周期，GPU 端渲染
- **性能优化**：支持 60,000+ 粒子，Debug 模式自动降级

#### 2. 鱼群 AI (`fish.js`)
- **Boids 算法**：分离（Separation）、对齐（Alignment）、聚集（Cohesion）
- **IK 骨骼链**：12 关节的骨骼系统，实现流畅的鱼体运动
- **玩家吸引力**：其他鱼在 800px 范围内受到玩家吸引
- **碰撞避障**：基于图像遮罩的碰撞检测，避免游到岸上
- **噪声驱动**：Perlin 噪声提供自然随机运动

#### 3. 摄像机系统 (`camera.js`)
- **平滑跟随**：摄像机平滑跟随玩家鱼
- **坐标转换**：世界坐标 ↔ 屏幕坐标的双向转换
- **视野剔除**：只渲染视野内的鱼，提升性能
- **缩放控制**：支持动态缩放，Debug 模式可查看全地图

#### 4. 渲染管线
- **多层 Canvas**：
  - `canvas` - 背景层（池塘图片、涟漪）
  - `particle-canvas` - 粒子层（WebGL 渲染）
  - `overlay-canvas` - 遮罩层（荷叶遮罩）
- **渲染顺序**：背景 → 世界坐标渲染 → 粒子系统 → 遮罩层

## 🎮 功能特性

### 玩家控制
- **WASD** 控制橙色锦鲤移动
- 无输入时自动切换为 AI 行为
- 摄像机平滑跟随玩家

### 鱼群系统
- **20-24 条锦鲤**：随机分布在池塘中
- **群组系统**：鱼分为多个群组，同组鱼优先聚集
- **跟随行为**：其他鱼会跟随玩家鱼游动
- **智能避障**：自动避开岸边和其他鱼

### 视觉效果
- **粒子拖尾**：鱼体由粒子组成，尾巴有特殊拖尾效果
- **涟漪系统**：鱼游动时随机产生涟漪
- **荷叶遮罩**：顶层荷叶遮罩，营造层次感
- **碰撞遮罩**：基于图像亮度的碰撞检测

### Debug 模式
- **V 键切换**：切换 Debug 视野模式
- **鼠标滚轮**：Debug 模式下缩放视野
- **网格显示**：显示地图边界和网格
- **性能优化**：Debug 模式自动降低粒子密度

### 自定义控制
- **鱼体尺寸调节**：滑块控制鱼的大小（5% - 120%）
- **缩放按钮**：快速放大/缩小 20%/25%
- **重置功能**：一键重置为默认尺寸

## 📁 项目结构

```
fish-pond/
├── js/
│   ├── main.js                  # 主程序入口，游戏循环
│   ├── fish.js                  # 鱼类定义，AI 行为，图像采样
│   ├── chain.js                 # IK 骨骼链系统
│   ├── camera.js                # 摄像机系统，坐标转换
│   ├── keyboard.js               # 键盘输入处理
│   ├── simple-particles.js      # Regl 粒子系统
│   ├── landmarks.js             # 地图参照物（石头、水草等）
│   ├── noise.js                 # Perlin 噪声生成
│   ├── utils.js                 # 工具函数（Vec2 等）
│   ├── background-particles.js  # 背景粒子（备用）
│   ├── regl-background.js       # Regl 背景渲染（备用）
│   ├── regl-particles.js        # Regl 粒子（备用）
│   └── three-scene.js           # Three.js 场景（备用）
├── css/
│   └── style.css                # 样式文件
├── assets/
│   ├── pond2.PNG                # 池塘背景图片
│   ├── lotus.PNG                # 荷叶遮罩图片
│   └── riverbank2.PNG           # 碰撞检测遮罩
├── index.html                   # 主 HTML 文件
└── package.json                 # 项目配置
```

## 🚀 快速开始

### 安装依赖

```bash
npm install
```

### 启动开发服务器

```bash
npm run serve
# 或
npm run dev
```

访问 `http://localhost:3000` 查看效果。

## 🎯 核心算法

### Boids 算法
鱼群行为基于经典的 Boids 算法，包含三个核心力：

1. **分离（Separation）**：避免与邻近鱼碰撞
2. **对齐（Alignment）**：与邻近鱼保持相同方向
3. **聚集（Cohesion）**：向邻近鱼的中心移动

### IK 骨骼链
每条鱼由 12 个关节组成的骨骼链：
- 头部跟随目标位置
- 后续关节通过 IK 求解跟随前一个关节
- 角度约束保证鱼体自然弯曲

### 粒子采样
1. 在离屏 Canvas 上绘制鱼体（3000x3000 高分辨率）
2. 逐像素采样颜色（RGBA）
3. 根据采样位置判断是否为尾巴
4. 生成粒子，继承颜色和位置信息

### 碰撞检测
- 使用 `riverbank2.PNG` 作为碰撞遮罩
- 通过亮度判断：亮度 > 200 为可通过区域（池塘）
- 实时检查鱼的位置是否在可通行区域

## ⚙️ 配置说明

### 粒子系统配置 (`main.js`)
```javascript
particleSystem = new SimpleReglParticles(regl, {
    particleCount: 28000,      // 最大粒子数
    lifeSpan: 0.12,            // 粒子生命周期（秒）
    sizeRange: [1.5, 2.5],      // 粒子大小范围
    speedRange: [0.15, 0.8],    // 粒子速度范围
    spawnRate: 12000,          // 每秒生成粒子数
    colorStart: [1.0, 0.4, 0.2, 0.98],  // 起始颜色（RGBA）
    colorEnd: [1.0, 0.6, 0.3, 0.0]      // 结束颜色（RGBA）
});
```

### 鱼群配置 (`main.js`)
```javascript
fish.separationRadius = 130;   // 分离半径
fish.alignmentRadius = 180;     // 对齐半径
fish.cohesionRadius = 220;      // 聚集半径
fish.maxSpeed = 0.6;            // 最大速度
fish.maxForce = 0.03;          // 最大力
```

### 摄像机配置 (`camera.js`)
```javascript
camera.follow(target, 0.15);   // 平滑度（0-1，越大越平滑）
camera.setZoom(zoom);          // 设置缩放
camera.minZoom = 0.2;          // 最小缩放
camera.maxZoom = 1.5;          // 最大缩放
```

## 🎨 视觉效果

### 粒子渲染
- **圆形粒子**：使用 `gl_PointCoord` 实现圆形粒子
- **柔和边缘**：`smoothstep` 实现柔和边缘
- **发光效果**：叠加发光层增强视觉效果
- **颜色继承**：粒子继承鱼体颜色，尾巴粒子增强亮度

### 涟漪系统
- 鱼移动 300px 后，8% 概率触发涟漪
- 涟漪半径 150-250px，速度 120-200px/s
- 生命周期 2 秒，逐渐淡出

### 多层渲染
1. **背景层**：池塘背景图片，固定在世界坐标
2. **世界层**：涟漪、地图参照物（可选）
3. **粒子层**：WebGL 渲染的粒子系统
4. **遮罩层**：荷叶遮罩，营造层次感

## 🔧 性能优化

### 视野剔除
- 只渲染视野内的鱼（`camera.isInView()`）
- 减少不必要的粒子生成和渲染

### Debug 模式优化
- Debug 模式下降低采样密度（3px 采样）
- 根据缩放比例动态调整粒子数量
- 显示整个地图时自动降低粒子密度

### GPU 批量渲染
- 使用 Regl 批量渲染所有粒子
- 减少 WebGL 状态切换
- 使用正交投影矩阵优化渲染

### 对象池
- 粒子对象池管理，避免频繁创建/销毁
- 达到最大粒子数时移除最老的粒子

## 🌐 浏览器兼容性

需要支持 WebGL 的现代浏览器：
- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

## 📝 开发说明

### 添加新功能
1. **新鱼类型**：在 `fish.js` 中添加颜色配置
2. **新视觉效果**：在 `main.js` 的 `animate()` 函数中添加渲染逻辑
3. **新控制方式**：在 `keyboard.js` 中添加输入处理

### 调试技巧
- 按 **V** 键进入 Debug 模式，查看全地图
- 控制台会输出粒子数量、视野内鱼数等信息
- 使用浏览器开发者工具查看 WebGL 状态

## 📄 许可证

MIT License

## 🙏 致谢

- Regl 团队提供优秀的 WebGL 库
- Boids 算法的经典实现
- WebGL 社区的技术支持
